<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title></title>
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
  <link href='//mapbox.com/base/latest/base.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    .map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
</head>
<body>
<div id='map-tooltips-js' class='map'> </div>
<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
<script>
L.mapbox.accessToken = 'pk.eyJ1Ijoic2hpamllIiwiYSI6ImNpa2tmNnRmaDBiNWZ1ZG02NzJ1dDVvbG0ifQ.IvsMRqi-NR3n4wQC3d9TMQ';
var mapTooltipsJS = L.mapbox.map('map-tooltips-js', 'shijie.28a6ac8e')
  .setView([{{start_lat}}, {{start_lng}}], 10);
var myLayer = L.mapbox.featureLayer().addTo(mapTooltipsJS);

var geojson = [
  {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [{{start_lng}}, {{start_lat}}]
    },
    "properties": {
      "title": "{{first_name}}! Your journey starts here!",
      "description": "{{location}}",
      "icon": {
          "iconUrl": "{{pic}}",
          "iconSize": [80, 80], // size of the icon
          "iconAnchor": [25, 25], // point of the icon which will correspond to marker's location
          "popupAnchor": [0, -25], // point from which the popup should open relative to the iconAnchor
          "className": "dot"
      }
    }
  },
  {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [{{end_lng}}, {{end_lat}}]
    },
    "properties": {
      "title": "Destination Unknown",
      "description": "<em> Review Highlight</em>: {{review}}",
      "categories": "<em> Categories </em>: {% for category in biz.categories %} {{category['name']}} {% endfor %}",
      "image": "{{biz.rating_img_url_large}}",
      "icon": {
          "iconUrl": "https://www.mapbox.com/mapbox.js/assets/images/astronaut1.png",
          "iconSize": [80, 80], // size of the icon
          "iconAnchor": [25, 25], // point of the icon which will correspond to marker's location
          "popupAnchor": [0, -25], // point from which the popup should open relative to the iconAnchor
          "className": "dot"
      }
    }
  }
];

// Set a custom icon on each marker based on feature properties.
myLayer.on('layeradd', function(e) {
  var marker = e.layer,
    feature = marker.feature;
  marker.setIcon(L.icon(feature.properties.icon));
  
  var content;
  
  if (feature.properties.image) {
    content = '<h2>'+ feature.properties.title+'<\/h2>' + 
              '<img src="'+feature.properties.image +'" alt="">' + 
              '<br><br><p>' + feature.properties.description + '</p>' +
              '<p>' + feature.properties.categories + '</p>' +
              // "<br><form action='/request_uber' id='uber' method='POST'><input type='submit' class='button fill-orange' value='Sweep Away by Uber!'></input></form>" +
               "<br><button class='button fill-orange' id='trigger'>Get Uber!</button>" +
              "<a href='/dashboard' class='button fill-green'>Search Again</a>";
  } else {
    content = '<h2>' + feature.properties.title+'<\/h2>' + '<p>' + feature.properties.description+'</p>';
  }
  marker.bindPopup(content);
});
myLayer.setGeoJSON(geojson);
mapTooltipsJS.scrollWheelZoom.disable();

var params = {
  'start_lat': {{start_lat}},
  'start_lng': {{start_lng}},
  'end_lat': {{end_lat}},
  'end_lng': {{end_lng}}
};

function showUber(results) {
  confirm("You are about to call this " + results['display_name'] + ", product id: " + results['product_id'] + ". Are you sure you want to proceed?");
  $('#trigger').html("Uber called!");
};

function getUberJson() {
  $.post('/request_uber', params, showUber)
};

$('#map-tooltips-js').on('click', '#trigger', getUberJson);

</script>
</body>
</html>




<!-- 
<html>
<head>
        <meta charset="utf-8">
        <title>Destination Unknown</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <script type="text/javascript" src="/static/uber_login.js"></script>
</head>
<body>
    <p>Review Snippet: {{biz.snippet_text}} </p>
    <p>Biz Rating: {{biz.rating}} </p>
    <p>Biz Rating: <img src="{{biz.rating_img_url_large}}"></p>
    <p>Biz Picture: <img src="{{biz.image_url}}"><p>
    <p>Biz categories: {{biz.categories}}<p>
    <p>Mystery biz: {{biz.name}}</p>
    <p>Location: {{biz.location.coordinate.latitude}}, {{biz.location.coordinate.longitude}}</p>
    <form action='/request_uber' method='POST'>
        <input id='uber' type='submit' value='Click for Uber!'></input>
    </form>


    <script type="text/javascript">

    </script>
</body>
</html> -->