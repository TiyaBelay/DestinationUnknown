<!DOCTYPE html>
<html>
<head>
  <meta charset= "UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Destination ? Map</title>
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
  <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">


  <style>
    @import url(http://fonts.googleapis.com/css?family=Lato:300,400,700);
    body { margin:0; padding:0; width: 100%; height: 100%;}
    .map { position:absolute; top:0; bottom:0; width:100%; height: 100 %; z-index: 0}
    .dot { border-radius:50%; }

    .wrapper {
    width: 100%;
    height: 100%;
    /*outline: 1px dotted red;*/
    }

    .container {
        background-color: #B0B0B0;
        background: rgba(253, 119, 92, 0.80);
        color: #241C04;
        position:relative;
        z-index: 1;
/*        width: 100%;*/
        font-family: 'Lato', Calibri, Arial, sans-serif;
        padding-bottom: 1%;

    }
        


  </style>
</head>


<body>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">You are about to call Uber!</h4>
      </div>
      <div class="modal-body">
        <p>
          A Toyota Prius will be on its way to you. <img src="https://d1a3f4spazzrp4.cloudfront.net/uberex-sandbox/images/prius.jpg"/> <br> Eta is 4 minutes. Do you want to proceed?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancel" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirm" class="btn btn-primary">Be Swept Away!</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- <div class="alert alert-success">
  <strong>Success!</strong> Indicates a successful or positive action.
</div> -->

<div id="section1-wrapper" class='wrapper'>
  <div id='map-tooltips-js' class='map'> </div>

  <div class="container">
        <div class="col-xs-12 col-sm-12 col-md-12">
             <h3 class="text-center">{{first_name}}'s Destination Unknown</h3>
        </div>

        <div class="row text-center">
            <div class="col-xs-12 col-md-4">
              <i class="fa fa-mobile fa-lg"></i>
              <strong>  (203) 980-3811</strong>
            </div>

            <div class="col-xs-12 col-md-4">
                <i class="fa fa-map-marker fa-lg"></i>
                <strong>  {{location}} </strong>
            </div>

            <div class="col-xs-12 col-md-4">
                <i class="fa fa-bar-chart fa-lg"></i>
                <strong><a href="/show_stats">View Your Stats</a>
                </strong>
            </div>


        </div>
    </div>
</div>
<div id="section2-wrapper" class="wrapper">Another row of content</div>

<script>
L.mapbox.accessToken = 'pk.eyJ1Ijoic2hpamllIiwiYSI6ImNpa2tmNnRmaDBiNWZ1ZG02NzJ1dDVvbG0ifQ.IvsMRqi-NR3n4wQC3d9TMQ';
var mapTooltipsJS = L.mapbox.map('map-tooltips-js', 'shijie.28a6ac8e')
  .setView([{{end_lat}}, {{end_lng}}], 10);
var myLayer = L.mapbox.featureLayer().addTo(mapTooltipsJS);

var geojson = [
  {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [{{start_lng}}, {{start_lat}}]
    },
    "properties": {
      "title": "{{first_name}}! Your journey starts here!",
      "description": "{{location}}",
      "icon": {
          "iconUrl": "{{pic}}",
          "iconSize": [80, 80], // size of the icon
          "iconAnchor": [25, 25], // point of the icon which will correspond to marker's location
          "popupAnchor": [0, -25], // point from which the popup should open relative to the iconAnchor
          "className": "dot"
      }
    }
  },
  {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [{{end_lng}}, {{end_lat}}]
    },
    "properties": {
      "title": "Destination Unknown",
      "description": "<em> Review Highlight</em>: {{review}}",
      "categories": "<em> Categories </em>: {% for category in biz.categories %} {{category['name']}} {% endfor %}",
      "image": "{{biz.rating_img_url_large}}",
      "icon": {
          "iconUrl": "static/img/cat.png",
          "iconSize": [80, 80], // size of the icon
          "iconAnchor": [25, 25], // point of the icon which will correspond to marker's location
          "popupAnchor": [0, -25], // point from which the popup should open relative to the iconAnchor
          "className": "dot"
      }
    }
  }
];

// Set a custom icon on each marker based on feature properties.
myLayer.on('layeradd', function(e) {
  var marker = e.layer,
    feature = marker.feature;
  marker.setIcon(L.icon(feature.properties.icon));
  
  var content;
  
  if (feature.properties.image) {
    content = '<h2>'+ feature.properties.title+'<\/h2>' + 
              '<img src="'+feature.properties.image +'" alt="">' + 
              '<br><br><p>' + feature.properties.description + '</p>' +
              '<p>' + feature.properties.categories + '</p>' +
              // "<br><form action='/request_uber' id='uber' method='POST'><input type='submit' class='button fill-orange' value='Sweep Away by Uber!'></input></form>" +
              // "<a data-toggle='modal' href='#myModal' class='btn btn-lg btn-danger'>Sign!</a>" +
               "<br><button type='button' class='btn btn-info btn-lg btn-block' id='trigger' data-toggle='modal' data-target='.bs-example-modal-lg'>Get Uber!</button>" +
              "<a href='/search' class='btn btn-secondary btn-lg btn-block'>Search Again</a>";
  } else {
    content = '<h2>' + feature.properties.title+'<\/h2>' + '<p>' + feature.properties.description+'</p>';
  }
  marker.bindPopup(content);
});

myLayer.setGeoJSON(geojson);
mapTooltipsJS.scrollWheelZoom.disable();


var params = {
  'start_lat': {{start_lat}},
  'start_lng': {{start_lng}},
  'end_lat': {{end_lat}},
  'end_lng': {{end_lng}}
};

function showUber(results) {
  // $('#trigger').click(function() {
  //   $('#myModal').modal('show');
  // });
  // confirm("You are about to call this " + results['display_name'] + ", product id: " + results['product_id'] + ". Are you sure you want to proceed?");
  $('#myModal').modal('hide');

  $('#trigger').removeClass("btn btn-info btn-lg btn-block")
               .addClass("btn btn-success btn-lg btn-block")
               .attr("disabled", true)
               .html("Uber called!");
};

function getUberJson() {
  $.post('/request_uber', params, showUber);
};

// $('#map-tooltips-js').on('click', '#trigger', getUberJson);

$('#map-tooltips-js').on('click', '#trigger', function() {
  $('#myModal').modal('show');
  $('#confirm').on('click', getUberJson);

});



</script>
</body>
</html>

